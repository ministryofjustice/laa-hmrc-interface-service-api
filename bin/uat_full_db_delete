#!/bin/bash

echo 'Configuring variables'
HOST=$(kubectl -n "${K8S_NAMESPACE}" get secret rds-instance-output -o jsonpath="{.data.rds_instance_address}" | base64 --decode)
DB_NAME=$(kubectl -n "${K8S_NAMESPACE}" get secret rds-instance-output -o jsonpath="{.data.database_name}" | base64 --decode)
DB_USER=$(kubectl -n "${K8S_NAMESPACE}" get secret rds-instance-output -o jsonpath="{.data.database_username}" | base64 --decode)
DB_PWD=$(kubectl -n "${K8S_NAMESPACE}" get secret rds-instance-output -o jsonpath="{.data.database_password}" | base64 --decode)

echo "Ensuring port-forward-pod exists"
POD=$(kubectl -n "${K8S_NAMESPACE}" get pods | grep -m4 port-forward-pod | head -n1 | cut -d' ' -f 1)
if [ -z "$POD" ]; then
  echo 'Creating new port-forward-pod'
  kubectl -n "${K8S_NAMESPACE}" run port-forward-pod \
    --image=ministryofjustice/port-forward \
    --port=5432 \
    --env="REMOTE_HOST=${HOST}" \
    --env="LOCAL_PORT=5432" \
    --env="REMOTE_PORT=5432"
fi

echo 'Waiting for port-forward-pod to be ready'
kubectl -n "${K8S_NAMESPACE}"  wait --for=condition=ready pod port-forward-pod --timeout=32s

echo 'starting port-forwarding as a background job'
kubectl -n "${K8S_NAMESPACE}" port-forward port-forward-pod 5433:5432 &

UAT_RELEASE="$CIRCLE_BRANCH"
echo "Attempting to delete UAT database for: $UAT_RELEASE"

OLD_POD=$(kubectl -n "${K8S_NAMESPACE}" get pods | grep -m4 "${UAT_RELEASE}" | head -n1 | cut -d' ' -f 1)
if [ -z "$OLD_POD" ]; then
  echo "Ensuring ${UAT_RELEASE} pod has terminated"
  kubectl -n "${K8S_NAMESPACE}" wait --for=delete pod/"${UAT_RELEASE}" --timeout=32s
fi

echo 'Sending RDS delete command'
OUTPUT=""
for i in {1..3}; do
  sleep 3
  echo "Attempt: $i"
  GET_QUERY="SELECT datname FROM pg_database WHERE datname ILIKE '${UAT_RELEASE}%'"
  DATABASE=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -qtc "${GET_QUERY};" | xargs) # xargs trims the spaces around the psql output of names
  CLOSE_CONN_QUERY="SELECT pg_terminate_backend(pid)  FROM pg_stat_activity WHERE datname = '${DATABASE}'"
  CLOSE_CONNECTIONS=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -qtc "${CLOSE_CONN_QUERY};" | xargs)
  OUTPUT=$(psql postgres://"${DB_USER}":"${DB_PWD}"@localhost:5433/"${DB_NAME}" -c "DROP DATABASE \"${DATABASE}\";")
  [ $(echo "$OUTPUT" | grep -c 'DROP DATABASE') = 1 ] && break
done

echo 'Killing port-forwarding background job'
kill $!

echo 'Deleting port-forwarding pod'
kubectl -n "${K8S_NAMESPACE}" delete pod port-forward-pod --wait=false
