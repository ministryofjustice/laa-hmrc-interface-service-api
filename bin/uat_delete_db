#!/bin/sh

GIT_MESSAGE=$(git log --format=%B -n 1 $CIRCLE_SHA1)

echo "git message is: $GIT_MESSAGE"

case "$GIT_MESSAGE" in
  "Merge pull request #"*)
    MERGED_BRANCH=$(echo $GIT_MESSAGE | sed -n "s/^.*from ministryofjustice\/\s*\(\S*\).*$/\1/p")
    UAT_RELEASE="$(echo $MERGED_BRANCH | sed 's:^\w*\/::' | tr -s ' _/[]().' '-' | cut -c1-30 | sed 's/-$//')"

    echo "Attempting to delete UAT database for: $UAT_RELEASE"
    HOST=$(kubectl -n ${K8S_NAMESPACE} get secret rds-instance-output -o jsonpath="{.data.rds_instance_address}" | base64 --decode)
    DB_NAME=$(kubectl -n ${K8S_NAMESPACE} get secret rds-instance-output -o jsonpath="{.data.database_name}" | base64 --decode)
    DB_USER=$(kubectl -n ${K8S_NAMESPACE} get secret rds-instance-output -o jsonpath="{.data.database_username}" | base64 --decode)
    DB_PWD=$(kubectl -n ${K8S_NAMESPACE} get secret rds-instance-output -o jsonpath="{.data.database_password}" | base64 --decode)

    echo 'Sending RDS delete command'
    OUTPUT="";
    for ((i=1; i<4; ++i)); do
      echo "Attempt: $i"
      OUTPUT=`psql postgres://${DB_USER}:${DB_PWD}@localhost:5432/${DB_NAME} -c "DROP DATABASE \"${UAT_RELEASE}\";"`;
      echo "$OUTPUT"
      [ `echo $OUTPUT | grep -c 'DROP DATABASE'` = 0 ] && break
      sleep 5
    done

    echo 'Deleting port-forwarding pod'
    kubectl -n ${K8S_NAMESPACE} delete pod port-forward-pod
    ;;
  *) echo "This commit is not a merged pull request";;
esac
