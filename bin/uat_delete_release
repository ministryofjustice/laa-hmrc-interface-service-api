#!/bin/sh

GIT_MESSAGE=$(git log --format=%B -n 1 $CIRCLE_SHA1)

echo "git message is: $GIT_MESSAGE"

case "$GIT_MESSAGE" in
  "Merge pull request #"*)
    MERGED_BRANCH=$(echo $GIT_MESSAGE | sed -n "s/^.*from ministryofjustice\/\s*\(\S*\).*$/\1/p")
    UAT_RELEASE="$(echo $MERGED_BRANCH | sed 's:^\w*\/::' | tr -s ' _/[]().' '-' | cut -c1-30 | sed 's/-$//')"

    echo "Attempting to delete UAT release: $UAT_RELEASE"

    UAT_RELEASES=$(helm list --namespace=${K8S_NAMESPACE} --all)

    echo "Current UAT releases:"
    echo "$UAT_RELEASES"

    case "$UAT_RELEASES" in
      *"$UAT_RELEASE"*)
        echo "Deleting UAT release $UAT_RELEASE"
        helm delete $UAT_RELEASE --namespace=${K8S_NAMESPACE}
        POD=$(kubectl -n ${K8S_NAMESPACE} get pods | grep -m4 $UAT_RELEASE | head -n1 | cut -d' ' -f 1)
        echo Delete database via $POD
        kubectl -n ${K8S_NAMESPACE} exec -it $POD -- rake db:drop
        ;;
      *) echo "UAT release $UAT_RELEASE was not found";;
    esac
    ;;
  *) echo "This commit is not a merged pull request";;
esac
