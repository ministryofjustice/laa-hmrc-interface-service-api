#!/usr/bin/env ruby
require 'json'
require 'rest-client'

REPO_NAME = 'laa-hmrc-interface-service-api'.freeze
IGNORE = %w[main].freeze
DRYRUN = ARGV.empty?
DRYRUN_SUFFIX = DRYRUN ? '--dry-run' : ''.freeze

pr_response = RestClient.get("https://api.github.com/repos/ministryofjustice/#{REPO_NAME}/pulls")
open_pr = JSON.parse(pr_response.body, symbolize_names: true).map { |pr| pr[:head][:ref].gsub(%r{[()\[\]_/\s.]}, '-') }
br_response = RestClient.get("https://api.github.com/repos/ministryofjustice/#{REPO_NAME}/branches?per_page=100")
open_branches = JSON.parse(br_response.body, symbolize_names: true).map { |pr| pr[:name].gsub(%r{[()\[\]_/\s.]}, '-') }
github_resources = (open_branches + open_pr).uniq

uat_releases = JSON.parse(`helm list --namespace=${K8S_NAMESPACE} --all --output json`, symbolize_names: true)
deployed_releases = uat_releases.map { |helm| helm[:name] unless IGNORE.include? helm[:name] }.compact

puts 'Dry-run only - this will NOT delete any environments' if DRYRUN
deployed_releases.each do |release|
  if github_resources.map { |name| name.include?(release) }.any?
    puts "PR still open, retaining #{release}"
  else
    puts `helm --namespace=${K8S_NAMESPACE} delete #{release} #{DRYRUN_SUFFIX}`
  end
end
puts 're-run command followed by `true` to actually delete any instances' if DRYRUN
